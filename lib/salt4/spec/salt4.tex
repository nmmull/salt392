\documentclass{report}
\usepackage{mathpazo}
\usepackage{amsthm, amssymb, mathtools, stmaryrd}
\usepackage{xcolor}
\usepackage{mathpartir}
\usepackage{geometry}[margin=1in]
\pagenumbering{gobble}
\input{../../../macros.tex}
\title{\texttt{salt4}: Boxes}
\author{\texttt{CS392-M1}: \textit{Rust, In Practice and in Theory}}
\date{}

\begin{document}
\maketitle

\chapter*{Syntax}

\begin{align*}
  x
  &
  &\text{(variables, $\V$)} \\
  n
  &
  &\text{(integers, $\Z$)} \\
  w &\cceq x \alt \dref w &\text{(place expression, $\mathcal W$)} \\
  e
  &\cceq
  \unitt
  \alt n
  \alt \copye w
  \alt w
  \alt \brw w
  \alt \mbrw w
  \alt w \eqe e
  \alt \code{\{} \ p \ \code{\}}
  \alt \boxe e
  &\text{(expressions, $\E$)} \\
  s
  &\cceq
  \lete x \eqe e
  \alt \lete \mute x \eqe e
  \alt e
  &\text{(statements, $\mathcal S$)} \\
  p
  &\cceq
  e
  \alt s \semi p
  &\text{(programs, $\cP$)}
\end{align*}

\chapter*{Typing}

\begin{align*}
  l & &\text{(lifetimes, $\mathsf{Lt}$)}\\
  t
  &\cceq
  \unitty
  \alt \intty
  \alt \brw w
  \alt \mbrw w
  \alt \boxt t
  &\text{(types, $\T$)} \\
  \tilde t
  &\cceq
  \mvty t
  \alt t
  \alt \boxt \tilde t
  &\text{(partial types, $\tilde \T$)} \\
  m &\cceq \mathsf{imm} \alt \mathsf{mut} &\text{(mutability)} \\
  u &\cceq \langle \tilde t \rangle^{m}_l &\text{(slot types, $\mathbb S_{\T}$)}\\
  \\
  \G &\in \V \mapsto \mathbb S_\T & \text{(contexts)}\\
  \\
  &\mathsf{copyable}(t) & \text{(copyability)} \\
  \G &\ent \mathsf{readable}(w) &\text{(readability)} \\
  \G &\ent \mathsf{writable}(w) &\text{(writability)} \\
  \G &\ent \mathsf{mutable}(w) &\text{(mutability)} \\
  \G &\ent \tilde t \approx \tilde t &\text{(type compatibility)} \\
  \G &\ent \tilde t : l &\text{(lifetimes)} \\
  \G &\ent w : u & \text{(place expressions)} \\
  \G &\ent \langle e : t \rangle_l \tne \G &\text{(expressions)} \\
  \G &\ent \langle s \rangle_l \tne \G &\text{(statments)} \\
  \G &\ent \langle p : t \rangle_l \tne \G &\text{(programs)}
\end{align*}

\begin{mathpar}
  \inferrule*[right=var]{
    (x \mapsto \langle \tilde t \rangle^m_l) \in \G
  }{
    \G \ent x : \langle \tilde t \rangle^m_l
  }
  \and
  \inferrule*[right=deref]{
    \G \ent w : \langle \brw x \rangle^{m_1}_{l_1}
    \and
    \G \ent x : \langle \tilde t \rangle^{m_2}_{l_2}
  }{
    \G \ent \dref w : \langle \tilde t \rangle^{m_2}_{l_2}
  }
  \and
  \inferrule*[right=mutDeref]{
    \G \ent w : \langle \mbrw x \rangle^{m_1}_{l_1}
    \and
    \G \ent x : \langle \tilde t \rangle^{m_2}_{l_2}
  }{
    \G \ent \dref w : \langle \tilde t \rangle^{m_2}_{l_2}
  }
  \and
  \inferrule*[right=box]{
    \G \ent w : \langle \boxt \tilde t \rangle^m_l
  }{
    \G \ent \dref w : \langle \tilde t \rangle^m_l
  }
  \and
  \inferrule*[right=unit]{
  }{
    \G \ent \langle \unt : \unt  \rangle_l \tne \G
  }
  \and
  \inferrule*[right=int]{
    n \in \Z
  }{
    \G \ent \langle n : \intt \rangle_l \tne \G
  }
  \and
  \inferrule*[right=readable]{
    \nexists y,j . (y \mapsto \langle \mbrw \code *^j x \rangle^m_l) \in \G
  }{
    \readable \G {\code *^k x}
  }
  \and
  \inferrule*[right=copyUnit]{
  }{
    \copyable{\unt}
  }
  \and
  \inferrule*[right=copyInt]{
  }{
    \copyable{\intt}
  }
  \and
  \inferrule*[right=copyRef]{
  }{
    \copyable{\brw w}
  }
  \and
  \inferrule*[right=placeCopy]{
    \G \ent w : \langle t \rangle^m_{l_1}
    \and
    \readable \G w
    \and
    \copyable{t}
  }{
    \G \ent \langle \copye w : t \rangle_{l_2} \tne \G
  }
  \and
  \inferrule*[right=writable]{
    \readable \G {\code *^k x}
    \and
    \nexists y,j . (y \mapsto \langle \brw \code *^j x \rangle^m_l) \in \G
  }{
    \writable \G {\code *^k x}
  }
\end{mathpar}

\begin{align*}
  \move \G x &= \G[x \mapsto \langle \mvty t \rangle^m_l] \qquad \text{where} \qquad (x \mapsto \langle t \rangle^m_l) \in \G \\
  \move \G {\code *^{k + 1} x} &=
\end{align*}

\begin{mathpar}
  \inferrule*[right=placeMove]{
    \G \ent w : \langle t \rangle^m_{l_1}
    \and
    \writable \G w
  }{
    \G \ent \langle w : t \rangle_{l_2} \tne \move \G w
  }
  \and
  \inferrule*[right=placeMove]{
    \G \ent x : \langle \mbrw w \rangle^m_{l_1}
    \and
    \writable \G x
  }{
    \G \ent \langle x : \mbrw w \rangle_{l_2} \tne \Gamma[x \mapsto \langle \mvty {\mbrw w} \rangle^m_{l_1}]
  }
  \and
  \inferrule*[right=ref]{
    \G \ent w : \langle t \rangle^m_{l_1}
    \and
    \readable \G {w}
  }{
    \G \ent \langle \brw w : \brw w \rangle_{l_2} \tne \G
  }
  \and
  \inferrule*[right=mutVar]{
    (x \mapsto \langle t \rangle^\mutt_l) \in \G
  }{
    \mutable \G x
  }
  \and
  \inferrule*[right=mutDeref]{
    (x \mapsto \langle \mbrw w \rangle^m_l) \in \G
    \and
    \mutable \G {\code *^k w}
  }{
    \mutable \G {\code *^{k + 1} x}
  }
  \and
  \inferrule*[right=mutRef]{
    \G \ent w : \langle t \rangle ^{\mutt}_{l_1}
    \and
    \writable \G w
    \and
    \mutable \G w
  }{
    \G \ent \langle \mbrw w : \mbrw w \rangle_{l_2} \tne \G
  }
  \and
  \inferrule*[right=$\approx$-unit]{
  }{
    \G \ent \unt \approx \unt
  }
  \and
  \inferrule*[right=$\approx$-int]{
  }{
    \G \ent \intt \approx \intt
  }
  \and
  \inferrule*[right=$\approx$-ref]{
    \G \ent w_1 : \langle \tilde t_1 \rangle^{m_1}_{l_1}
    \and
    \G \ent w_2 : \langle \tilde t_2 \rangle^{m_2}_{l_2}
    \and
    \G \ent \tilde t_1 \approx \tilde t_2
  }{
    \G \ent \brw w_1 \approx \brw w_2
  }
  \and
  \inferrule*[right=$\approx$-mutRef]{
    \G \ent w_1 : \langle \tilde t_1 \rangle^{m_1}_{l_1}
    \and
    \G \ent w_2 : \langle \tilde t_2\rangle^{m_2}_{l_2}
    \and
    \G \ent \tilde t_1 \approx \tilde t_2
  }{
    \G \ent \mbrw w_1 \approx \mbrw w_2
  }
  \and
  \inferrule*[right=$\approx$-box]{
    \G \ent \tilde t_1 \approx \tilde t_2
  }{
    \G \ent \boxt \tilde t_1 \approx \boxt \tilde t_2
  }
  \and
  \inferrule*[right=$\approx$-partial$_1$]{
    \G \ent t_1 \approx \tilde t_2
  }{
    \G \ent \mvty {t_1} \approx \tilde t_2
  }
  \and
  \inferrule*[right=$\approx$-partial$_2$]{
    \G \ent \tilde t_1 \approx t_2
  }{
    \G \ent \tilde t_1 \approx \mvty {t_2}
  }
\end{mathpar}


\begin{align*}
  \writee(\G, x, t) &=
  \G[x \mapsto \langle t \rangle^m_l] \quad \text{where} \quad (x \mapsto \langle \cdot \rangle^m_l) \in \G\\
  \writee(\G, \code *^{k + 1}x, t) &=
  \writee(\G, \code *^k w, t) \quad \text{where} \quad (x \mapsto \langle \mbrw w \rangle^m_l) \in \G \\
  \\
  \mathsf{replace}(\brw \code{*}^{k + 1}w_1 , w_1, \brw w_2) &= \brw \code *^k w_2 \\
  \mathsf{replace}(\brw \code{*}^{k + 1}w_1 , w_1, \mbrw w_2) &= \brw \code *^k w_2 \\
  \mathsf{replace}(\mbrw \code{*}^{k + 1}w_1 , w_1, \brw w_2) &= \mbrw \code *^k w_2 \\
  \mathsf{replace}(\mbrw \code{*}^{k + 1}w_1 , w_1, \mbrw w_2) &= \mbrw \code *^k w_2 \\
  \mathsf{replace}(t_1, w, t_2) &= t_1 \\
  \mathsf{replace}(\mvty {t_1} , w, t_2) &= \mvty {\mathsf{replace}(t_1, w, t_2)} \\
  \mathsf{replace}(\G, w, t_2) &= \{ x \mapsto \langle \mathsf{replace}(\tilde t_1, w, t_2) \rangle^m_l : (x \mapsto \langle \tilde t_1 \rangle^m_l) \in \G \} \\
  \\
  \mathsf{update}(\G, w, t_2) &= \mathsf{replace}(\writee(\G, w, t_2), w, t_2) \\
  \\
  \mathsf{drop}(\G, l) &= \G \setminus \{ x \mapsto \langle \tilde t \rangle^m_l : (x \mapsto \langle \tilde t \rangle^m_l) \in \G \}
\end{align*}

\begin{mathpar}
  \inferrule*[right=intLftm]{
  }{
    \G \ent \intty : l
  }
  \and
  \inferrule*[right=refLtfm]{
    G \ent w : \langle t \rangle^m_{l_1}
    \and
    l_1 \leq l_2
  }{
    \G \ent \brw w : l_2
  }
  \and
  \inferrule*[right=mutRefLftm]{
    \G \ent w : \langle t \rangle^m_{l_1}
    \and
    l_1 \leq l_2
  }{
    \G \ent \mbrw w : l_2
  }
  \and
  \inferrule*[right=boxLftm]{
    \G \ent t : l
  }{
    \G \ent \boxt t : l
  }
  \and
  \inferrule*[right=assign]{
    \G_1 \ent w : \langle \tilde t_1 \rangle^\mutt_{l_1}
    \and
    \G_1 \ent e : t_2 \tne \G_2
    \and
    \G_2 \ent \tilde t_1 \approx t_2
    \\
    \G_2 \ent t_2 : l_1
    \and
    \G_3 = \mathsf{update}(\G, w, t_2)
    \and
    \writable {\G_3} w
  }{
    \G_1 \ent \langle w \eqe e : \unt \rangle_{l_2} \tne \G_3
  }
  \and
  \inferrule*[right=block]{
    \G_1 \ent \langle p : t \rangle_{l + 1} \tne \G_2
    \and
    \G_2 \ent t : l
  }{
    \G_1 \ent \langle \code{\{} \ p \ \code{\}} : t \rangle_l \tne \mathsf{drop}(\G_2, l + 1)
  }
  \and
  \inferrule*[right=let]{
    \G_1 \ent \langle e : t \rangle_l \tne \G_2
    \and
    x \not \in \dom(\G_2)
  }{
    \G_1 \ent \langle \lete x \eqe e \rangle_l \tne \G_2[x \mapsto \langle t \rangle^{\imm}_l]
  }
  \and
  \inferrule*[right=letMut]{
    \G_1 \ent \langle e : t \rangle_l \tne \G_2
    \and
    x \not \in \dom(\G_2)
  }{
    \G_1 \ent \langle \lete \mute x \eqe e \rangle_l \tne \G_2[x \mapsto \langle t \rangle^{\mutt}_l]
  }
  \and
  \inferrule*[right=exprStmt]{
    \G_1 \ent \langle e : t \rangle_l \tne \G_2
  }{
    \G_1 \ent \langle e \rangle_l \tne \G_2
  }
  \and
  \inferrule*[right=prog]{
    \G_1 \ent \langle s \rangle_l \tne \G_2
    \and
    \G_2 \ent \langle p : t \rangle_l \tne \G_3
  }{
    \G_1 \ent \langle s \semi p : t \rangle_l \tne \G_3
  }
\end{mathpar}

\chapter*{Evaluation}

\begin{align*}
  \ell &\cceq \ell_x &\text{(locations, $\mathcal L$)} \\
  v
  &\cceq \unitt \alt n \alt \ell
  &\text{(values, $\Val$)} \\
  \tilde v
  &\cceq \bot \alt v
  &\text{(partial values, $\tilde \Val$)} \\
  r &\cceq \langle \tilde v \rangle_l &\text{(slot types, $\mathbb S_{\Val}$)}\\
  \\
  S &\in \Loc \mapsto \mathbb S_\Val &\text{(store)} \\
  \\
  S &\ent \langle e \evl v \rangle_l \tne S &\text{(expressions)} \\
  S &\ent \langle s \rangle_l \tne S &\text{(statements)} \\
  S &\ent \langle p \evl v \rangle_l \tne S &\text{(programs)} \\
\end{align*}

\pagebreak

\begin{mathpar}
  \inferrule*[right=locVar]{
  }{
    S \ent x \rightsquigarrow \ell_x
  }
  \and
  \inferrule*[right=locDeref]{
    S \ent w \rightsquigarrow \ell_x
    \and
    (\ell_x \mapsto \langle \ell_y \rangle_l) \in S
  }{
    S \ent \dref w \rightsquigarrow \ell_y
  }
  \and
  \inferrule*[right=unit]{
  }{
    S \ent \langle \unt \evl \unt \rangle_l \tne S
  }
  \and
  \inferrule*[right=int]{
    n \in \Z
  }{
    S \ent \langle n \evl n \rangle_l \tne S
  }
  \and
  \inferrule*[right=placeCopy]{
    S \ent w \rightsquigarrow \ell_x
    \and
    (\ell_x \mapsto \langle v \rangle_{l_1}) \in S
  }{
    S \ent \langle \copye w \evl v \rangle_{l_2} \tne S
  }
  \and
  \inferrule*[right=move]{
    S \ent w \rightsquigarrow \ell_x
    \and
    (\ell_x \mapsto \langle v \rangle_{l_1}) \in S
  }{
    S \ent \langle w \evl v \rangle_{l_2} \tne S[\ell_x \mapsto \langle \bot \rangle_{l_1}]
  }
  \and
  \inferrule*[right=ref]{
    S \ent w \rightsquigarrow \ell_x
  }{
    S \ent \langle \brw w \evl \ell_x \rangle_l \tne S
  }
  \and
  \inferrule*[right=mutRef]{
    S \ent w \rightsquigarrow \ell_x
  }{
    S \ent \langle \mbrw w \evl \ell_x \rangle_l \tne S
  }
  \and
  \inferrule*[right=assign]{
    S \ent w \rightsquigarrow \ell_x
    \and
    (\ell_x \mapsto \langle \tilde v \rangle_{l_1}) \in S_1
    \and
    S_1 \ent \langle e \evl v \rangle_{l_2} \tne S_2
  }{
    S_1 \ent \langle w \eqe e \evl \unt \rangle_{l_2} \tne S_2[\ell_x \mapsto \langle v \rangle_{l_1}]
  }
\end{mathpar}

\begin{align*}
  \mathsf{drop}(S, l) = S \setminus \{ \ell \mapsto \langle \tilde v \rangle_l : (\ell \mapsto \langle \tilde v \rangle_l) \in S\}
\end{align*}

\begin{mathpar}
  \inferrule*[right=block]{
    S_1 \ent  \langle p \evl v \rangle_{l + 1} \tne S_2
  }{
    S_1 \ent {\code{\{} \ p \ \code{\}}} \evl v \tne {\mathsf{drop}(S_2, l + 1)}
  }
  \and
  \inferrule*[right=let]{
    S_1 \ent \langle e \evl v \rangle_l \tne S_2
  }{
    S_1 \ent \langle \lete x \eqe e \rangle_l \tne S_2[\ell_x \mapsto \langle v \rangle_l]
  }
  \and
  \inferrule*[right=letMut]{
    S_1 \ent \langle e \evl v \rangle \tne S_2
  }{
    S_1 \ent \langle \lete \mute x \eqe e \rangle \tne S_2[\ell_x \mapsto \langle v \rangle_l]
  }
  \and
  \inferrule*[right=exprStmt]{
    S_1 \ent \langle e \evl v \rangle_l \tne S_2
  }{
    S_1 \ent \langle e \rangle_l \tne S_2
  }
  \and
  \inferrule*[right=prog]{
    S_1 \ent \langle s \rangle_l \tne S_2
    \and
    S_2 \ent \langle p \evl v \rangle_l \tne S_3
  }{
    S_1 \ent \langle s \semi p \evl v \rangle_l \tne S_3
  }
\end{mathpar}
\end{document}
