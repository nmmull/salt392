\documentclass{report}
\usepackage{mathpazo}
\usepackage{amsthm, amssymb, mathtools, stmaryrd}
\usepackage{xcolor}
\usepackage{mathpartir}
\usepackage{geometry}[margins=1in]
\pagenumbering{gobble}
\input{../../../macros.tex}
\title{\texttt{salt1}: Immutable References}
\author{\texttt{CS392-M1}: \textit{Rust, In Practice and in Theory}}
\date{}

\begin{document}
\maketitle

\chapter*{Syntax}

\begin{align*}
  x
  &
  &\text{(variables, $\V$)} \\
  n
  &
  &\text{(integers, $\Z$)} \\
  w &\cceq x \alt \dref w &\text{(place expression, $\mathcal W$)} \\
  e
  &\cceq
  \unitt
  \alt n
  \alt w
  \alt \brw w
  \alt x \eqe e
  &\text{(expressions, $\E$)} \\
  s
  &\cceq
  \lete x \eqe e
  \alt \lete \mute x \eqe e
  \alt e
  &\text{(statements, $\mathcal S$)} \\
  p
  &\cceq
  e
  \alt s \semi p
  &\text{(programs, $\cP$)}
\end{align*}

\chapter*{Typing}

\begin{align*}
  t
  &\cceq
  \unitty
  \alt \intty
  \alt \brw x
  &\text{(types, $\T$)} \\
  m &\cceq \mathsf{imm} \alt \mathsf{mut} &\text{(mutability)} \\
  u &\cceq \langle t \rangle^m &\text{(slot types, $\mathbb S_{\T}$)}\\
  \\
  \G &\in \V \mapsto \mathbb S_\T & \text{(contexts)}\\
  \\
  \G &\ent \mathsf{writable}(x) &\text{(writability)} \\
  \G &\ent w : u & \text{(place expressions)} \\
  \G &\ent t \approx t &\text{(type compatibility)} \\
  \G &\ent e : t \tne \G &\text{(expressions)} \\
  \G &\ent s \tne \G &\text{(statments)} \\
  \G &\ent p : t \tne \G &\text{(programs)}
\end{align*}
\bigskip

\begin{mathpar}
  \inferrule*[right=var]{
    (x \mapsto t^m) \in \G
  }{
    \G \ent x : \langle t \rangle^m
  }
  \and
  \inferrule*[right=deref]{
    \G \ent w : \langle \brw x \rangle^{m_1}
    \and
    \G \ent x : \langle t \rangle^{m_2}
  }{
    \G \ent \dref w : \langle t \rangle^{m_2}
  }
  \and
  \inferrule*[right=unit]{
  }{
    \G \ent \unt : \unt
  }
  \and
  \inferrule*[right=int]{
    n \in \Z
  }{
    \G \ent n : \intt \tne \G
  }
  \and
  \inferrule*[right=place]{
    \G \ent w : \langle t \rangle^m
  }{
    \G \ent w : t \tne \G
  }
  \and
  \inferrule*[right=refVar]{
    \G \ent x : \langle t \rangle^m
  }{
    \G \ent \brw x : \brw x \tne \G
  }
  \and
  \inferrule*[right=refDeref]{
    \G \ent w : \langle \brw x \rangle^m
  }{
    \G \ent \brw \dref w : \brw x \tne \G
  }
  \and
  \inferrule*[right=$\approx$-unit]{
  }{
    \G \ent \unt \approx \unt
  }
  \and
  \inferrule*[right=$\approx$-int]{
  }{
    \G \ent \intt \approx \intt
  }
  \and
  \inferrule*[right=$\approx$-ref]{
    \G \ent x_1 : \langle t_1 \rangle^{m_1}
    \and
    \G \ent x_2 : \langle t_2 \rangle^{m_2}
    \and
    \G \ent t_1 \approx t_2
  }{
    \G \ent \brw x_1 \approx \brw x_2
  }
  \and
  \inferrule*[right=writable]{
    \nexists y . (y \mapsto \brw x) \in \G
  }{
    \writable \G x
  }
  \and
  \inferrule*[right=assign]{
    \G_1 \ent x : \langle t_1 \rangle^{\mutt}
    \and
    \G_1 \ent e : t_2 \tne \G_2
    \and
    \G_2 \ent t_1 \approx t_2
    \and
    \writable {\G_2} x
  }{
    \G_1 \ent x \eqe e : \unt \tne \G_2[x \mapsto t_2^{\mutt}]
  }
  \and
  \inferrule*[right=let]{
    \G_1 \ent e : t \tne \G_2
    \and
    x \not \in \dom(\G_2)
  }{
    \G_1 \ent \lete x \eqe e \tne \G_2[x \mapsto t^{\imm}]
  }
  \and
  \inferrule*[right=letMut]{
    \G_1 \ent e : t \tne \G_2
    \and
    x \not \in \dom(\G_2)
  }{
    \G_1 \ent \lete \mute x \eqe e \tne \G_2[x \mapsto t^{\mutt}]
  }
  \and
  \inferrule*[right=exprStmt]{
    \G_1 \ent e : t \tne \G_2
  }{
    \G_1 \ent e \tne \G_2
  }
  \and
  \inferrule*[right=prog]{
    \G_1 \ent s \tne \G_2
    \and
    \G_2 \ent p : t \tne \G_3
  }{
    \G_1 \ent s \semi p : t \tne \G_3
  }
\end{mathpar}

\chapter*{Evaluation}

\begin{align*}
  \ell &\cceq \ell_x &\text{(locations, $\mathcal L$)} \\
  v
  &\cceq \unitt \alt n \alt \ell
  &\text{(values, $\Val$)} \\
  \\
  S &\in \Loc \mapsto \Val &\text{(store)} \\
  \\
  S &\ent w \rightsquigarrow \ell &\text{(place locations)} \\
  S &\ent e \evl v \tne S &\text{(expressions)} \\
  S &\ent s \tne S &\text{(statements)} \\
  S &\ent p \evl v \tne S &\text{(programs)}
\end{align*}
\bigskip

\begin{mathpar}
  \inferrule*[right=locVar]{
  }{
    S \ent x \rightsquigarrow \ell_x
  }
  \and
  \inferrule*[right=locDeref]{
    S \ent w \rightsquigarrow \ell_x
    \and
    (\ell_x \mapsto \ell_y) \in S
  }{
    S \ent \dref w \rightsquigarrow \ell_y
  }
  \and
  \inferrule*[right=unit]{
  }{
    S \ent \unt \evl \unt \tne S
  }
  \and
  \inferrule*[right=int]{
    n \in \Z
  }{
    S \ent n \evl n \tne S
  }
  \and
  \inferrule*[right=place]{
    S \ent w \rightsquigarrow \ell_x
    \and
    (\ell_x \mapsto v) \in S
  }{
    S \ent w \evl v \tne S
  }
  \and
  \inferrule*[right=ref]{
    S \ent w \rightsquigarrow \ell_x
  }{
    S \ent \brw w \evl \ell_x \tne S
  }
  \and
  \inferrule*[right=assign]{
    \ell_x \in \dom(S)
    \and
    S_1 \ent e \evl v \tne S_2
  }{
    S_1 \ent x \eqe e \evl \unt \tne S_2[\ell_x \mapsto v]
  }
  \and
  \inferrule*[right=let]{
    S_1 \ent e \evl v \tne S_2
  }{
    S_1 \ent \lete x \eqe e \tne S_2[\ell_x \mapsto v]
  }
  \and
  \inferrule*[right=letMut]{
    S_1 \ent e \evl v \tne S_2
  }{
    S_1 \ent \lete \mute x \eqe e \tne S_2[\ell_x \mapsto v]
  }
  \and
  \inferrule*[right=exprStmt]{
    S_1 \ent e \evl v \tne S_2
  }{
    S_1 \ent e \tne S_2
  }
  \and
  \inferrule*[right=prog]{
    S_1 \ent s \tne S_2
    \and
    S_2 \ent p \evl v \tne S_3
  }{
    S_1 \ent s \semi p \evl v \tne S_3
  }
\end{mathpar}
\end{document}
