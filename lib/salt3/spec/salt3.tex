\documentclass{report}
\usepackage{mathpazo}
\usepackage{geometry}[margin=1in]
\usepackage{amsthm, amssymb, mathtools, stmaryrd}
\usepackage{todonotes} %% has coloring?
\usepackage{bussproofs}
\pagenumbering{gobble}
\input{../../../macros.tex}
\title{\texttt{salt3}: Blocks}
\author{\texttt{CS392-M1}: \textit{Rust, In Practice and in Theory}}
\date{}

\begin{document}
\maketitle

\chapter*{Syntax}

\begin{align*}
  x
  &
  &\text{(variables, $\V$)} \\
  n
  &
  &\text{(integers, $\Z$)} \\
  w &\cceq x \alt \dref w &\text{(place expression, $\mathcal W$)} \\
  e
  &\cceq
  \unitt
  \alt n
  \alt w
  \alt \brw w
  \alt \mbrw w
  \alt \copye w
  \alt w \eqe e
  \alt \code{\{} \ p \ \code{\}}
  &\text{(expressions, $\E$)} \\
  s
  &\cceq
  e
  \alt \lete x \eqe e
  \alt \lete \mute x \eqe e
  &\text{(statements, $\mathcal S$)} \\
  p
  &\cceq
  e
  \alt s \semi p
  &\text{(programs, $\cP$)}
\end{align*}

\chapter*{Typing}

\begin{align*}
  l & &\text{(lifetimes, $\mathsf{Lt}$)}\\
  t
  &\cceq
  \unitty
  \alt \intty
  \alt \brw w
  \alt \mbrw w
  &\text{(types, $\T$)} \\
  \tilde t
  &\cceq
  \mvty t
  \alt t
  &\text{(partial types, $\tilde \T$)} \\
  m &\cceq \mathsf{imm} \alt \mathsf{mut} &\text{(mutability)} \\
  u &\cceq \langle \tilde t \rangle^{m}_l &\text{(slot types, $\mathbb S_{\T}$)}\\
  \\
  \G &\in \V \mapsto \mathbb S_\T & \text{(contexts)}\\
  \\
  &\mathsf{copyable}(t) & \text{(copyability)} \\
  \G &\ent w : u & \text{(place expressions)} \\
  \G &\ent \mathsf{readable}(w) &\text{(readability)} \\
  \G &\ent \mathsf{writable}(w) &\text{(writability)} \\
  \G &\ent \tilde t \approx \tilde t &\text{(type compatibility)} \\
  \G &\ent \langle e : t \rangle_l \tne \G &\text{(expressions)} \\
  \G &\ent \langle s \rangle_l \tne \G &\text{(statments)} \\
  \G &\ent \langle p : t \rangle_l \tne \G &\text{(programs)}
\end{align*}

\begin{center}
  \AxiomC{$(x \mapsto \langle \tilde t \rangle^m_l) \in \G$}
  \RightLabel{(var)}
  \UnaryInfC{$\G \ent x : \langle \tilde t \rangle^m_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent w_1 : \langle \brw w_2 \rangle^{m_1}_{l_1}$}
  \AxiomC{$\G \ent w_2 : \langle t \rangle^{m_2}_{l_2}$}
  \RightLabel{(deref)}
  \BinaryInfC{$\G \ent \dref w_1 : \langle t \rangle^{m_2}_{l_2}$}
  \DisplayProof
\end{center}


\begin{center}
  \AxiomC{}
  \RightLabel{(unit)}
  \UnaryInfC{$\G \ent \langle \unt : \unt \rangle_l \tne \G$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$n \in \mathbb Z$}
  \RightLabel{(int)}
  \UnaryInfC{$\G \ent \langle n : \intt \rangle_l \tne \G$}
  \DisplayProof
\end{center}

\begin{prooftree}
  \AxiomC{$\nexists y,l . (y \mapsto \mbrw \code *^l x) \in \Gamma$}
  \RightLabel{(readable)}
  \UnaryInfC{$\readable \Gamma {\code *^k x}$}
\end{prooftree}

\begin{center}
  \AxiomC{}
  \RightLabel{(copy-unit)}
  \UnaryInfC{$\mathsf{copyable}(\unitt)$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{}
  \RightLabel{(copy-int)}
  \UnaryInfC{$\mathsf{copyable}(\intt)$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{}
  \RightLabel{(copy-brw)}
  \UnaryInfC{$\mathsf{copyable}(\brw w)$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent w : \langle t \rangle^m_{l_1}$}
  \AxiomC{$\readable \G w$}
  \AxiomC{$\mathsf{copyable}(t)$}
  \RightLabel{(place-copy)}
  \TrinaryInfC{$\G \ent \langle \copye w : t \rangle_{l_2} \tne \G$}
  \DisplayProof
\end{center}

\begin{prooftree}
  \AxiomC{$\readable \Gamma {\code *^k x}$}
  \AxiomC{$\nexists y,l . (y \mapsto \brw \code *^l x) \in \Gamma$}
  \RightLabel{(writable)}
  \BinaryInfC{$\writable \Gamma {\code *^k x}$}
\end{prooftree}

\begin{center}
  \AxiomC{$\G \ent x : \langle \mbrw w \rangle^m_{l_1}$}
  \AxiomC{$\writable \G x$}
  \RightLabel{(place-move)}
  \BinaryInfC{$\G \ent \langle x : \mbrw w \rangle_{l_2} \tne \Gamma[x \mapsto \mvty {\mbrw w}]$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent w : \langle t \rangle^m_{l_1}$}
  \AxiomC{$\readable \G {w}$}
  \RightLabel{(brw)}
  \BinaryInfC{$\G \ent \langle \brw w : \brw w \rangle_{l_2} \tne \Gamma$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent w : \langle t \rangle ^{\mathsf{mut}}_{l_1}$}
  \AxiomC{$\writable \G {w}$}
  \AxiomC{$\mutable \G w$}
  \RightLabel{(mut-brw)}
  \TrinaryInfC{$\G \ent \langle \mbrw w : \mbrw w \rangle_{l_2} \tne \Gamma$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{}
  \RightLabel{($\approx$-int)}
  \UnaryInfC{$\Gamma \vdash \intty \approx \intty$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{}
  \RightLabel{($\approx$-unit)}
  \UnaryInfC{$\Gamma \vdash \unitty \approx \unitty$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent w_1 : \langle \tilde t_1 \rangle^{m_1}_{l_1}$}
  \AxiomC{$\G \ent w_2 : \langle \tilde t_2 \rangle^{m_2}_{l_2}$}
  \AxiomC{$\G \ent \tilde t_1 \approx \tilde t_2$}
  \RightLabel{($\approx$-brw)}
  \TrinaryInfC{$\G \ent \brw w_1 \approx \brw w_2$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent w_1 : \langle \tilde t_1 \rangle^{m_1}_{l_1}$}
  \AxiomC{$\G \ent w_2 : \langle \tilde t_2 \rangle^{m_2}_{l_2}$}
  \AxiomC{$\G \ent \tilde t_1 \approx \tilde t_2$}
  \RightLabel{($\approx$-mbrw)}
  \TrinaryInfC{$\G \ent \mbrw w_1 \approx \mbrw w_2$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent t_1 \approx \tilde t_2$}
  \RightLabel{($\approx$-partial$_1$)}
  \UnaryInfC{$\G \ent \mvty {t_1} \approx \tilde t_2$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G \ent \tilde t_1 \approx t_2$}
  \RightLabel{($\approx$-partial$_2$)}
  \UnaryInfC{$\G \ent \tilde t_1 \approx \mvty {t_2}$}
  \DisplayProof
\end{center}

\begin{align*}
  \writee(\G, x, t) &= \G[x \mapsto t] \\
  \writee(\G, \code*^{k + 1}x, t) &= \writee(\G, \code*^k w, t) \quad \text{where} \quad (x \mapsto \mbrw w^m) \in \G \\
\end{align*}
\begin{align*}
  \mathsf{replace}(\code{\&}\code{*}^{k + 1}w_1 , w_1, \code{\&}[\code{mut}] w_2) &= \code{\&}\code{*}^k w_2 \\
  \mathsf{replace}(\code{\&}\code{mut} \ \code{*}^{k + 1}w_1 , w_1, \code{\&}[\code{mut}] w_2) &= \code{\&}\code{mut} \ \code{*}^k w_2 \\
  \mathsf{replace}(t_1, w, t_2) &= t_1 \\
  \mathsf{replace}(\mvty {t_1} , w, t_2) &= \mvty {\mathsf{replace}(t_1, w, t_2)} \\
  \mathsf{replace}(\G, w, t_2) &= \{ x \mapsto \mathsf{replace}(\tilde t_1, w, t_2) : (x \mapsto \tilde t_1) \in \G \}
\end{align*}

\begin{align*}
  \mathsf{update}(\G, w, t_2) = \mathsf{replace}(\writee(\G, w, t_2), w, t_2)
\end{align*}

\begin{prooftree}
  \AxiomC{}
  \RightLabel{(int-lftm)}
  \UnaryInfC{$\G \ent \intty : l$}
\end{prooftree}

\begin{prooftree}
  \AxiomC{$\Gamma \ent w : \langle t \rangle^m_{l_1}$}
  \AxiomC{$l_1 \leq l_2$}
  \RightLabel{(brw-lftm)}
  \BinaryInfC{$\G \ent \brw w : l_2$}
\end{prooftree}

\begin{prooftree}
  \AxiomC{$\Gamma \ent w : \langle t \rangle^m_{l_1}$}
  \AxiomC{$l_1 \leq l_2$}
  \RightLabel{(mut-brw-lftm)}
  \BinaryInfC{$\G \ent \mbrw w : l_2$}
\end{prooftree}

\begin{prooftree}
  \AxiomC{$\G_1 \ent w : \langle \tilde t_1 \rangle^{\mathsf{mut}}_{l_1}$}
  \AxiomC{$\G_1 \ent e : t_2 \tne \G_2$}
  \AxiomC{$\G_2 \ent \tilde t_1 \approx t_2$}
  \noLine
  \TrinaryInfC{
    $\G_2 \ent t_2 : l_1
    \qquad \G_3 = \mathsf{update}(\G, w, t_2)
    \qquad \writable {\G_3} w$
  }
  \RightLabel{(assign)}
  \UnaryInfC{$\G_1 \ent \langle w \eqe e : \unitt \rangle_{l_2} \tne \G_3$}
\end{prooftree}

\begin{align*}
  \mathsf{drop}(\G, l) &= \G \setminus \{ x \mapsto \langle \tilde t \rangle^m_l : (x \mapsto \langle \tilde t \rangle^m_l) \in \Gamma\}
\end{align*}

\begin{prooftree}
  \AxiomC{$\G_1 \ent \langle p : t \rangle_{l + 1} \tne \G_2$}
  \AxiomC{$\G_2 \ent t : l$}
  \RightLabel{(block)}
  \BinaryInfC{$\G_1 \ent \langle \code{\{} \ p \ \code{\}} : t \rangle_l \tne \mathsf{drop}(\G_2, l + 1)$}
\end{prooftree}

\begin{center}
  \AxiomC{$\G_1 \ent \langle e : t \rangle_l \tne \G_2$}
  \RightLabel{(expr-stmt)}
  \UnaryInfC{$\G_1 \ent \langle e \rangle_l \tne \G_2$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G_1 \ent \langle e : t \rangle_l \tne \G_2$}
  \AxiomC{$x \not \in \mathsf{dom}(\G_2)$}
  \RightLabel{(let)}
  \BinaryInfC{$\G_1 \ent \langle \lete x \eqe e \rangle_l \tne \G_2[x \mapsto \langle t \rangle^{\mathsf{imm}}_l]$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\G_1 \ent \langle e : t \rangle_l \tne \G_2$}
  \AxiomC{$x \not \in \mathsf{dom}(\G_2)$}
  \RightLabel{(let-mut)}
  \BinaryInfC{$\G_1 \ent \langle \lete \mute x \eqe e \rangle_l \tne \G_2[x \mapsto \langle t \rangle^{\mathsf{mut}}_l]$}
  \DisplayProof
\end{center}

\begin{prooftree}
  \AxiomC{$\G_1 \ent \langle s \rangle_l \tne \G_2$}
  \AxiomC{$\G_2 \ent \langle p : t \rangle_l \tne \G_3$}
  \RightLabel{(prog)}
  \BinaryInfC{$\G_1 \ent \langle s \ \code{;} \ p : t \rangle_l \tne \G_3$}
\end{prooftree}

\chapter*{Evaluation}

\newcommand{\config}[2]{\ #1 \ , \ #2 \ }

\begin{align*}
  \ell &\cceq \ell_x &\text{(locations, $\mathcal L$)} \\
  v
  &\cceq \unitt \alt n \alt \ell
  &\text{(values, $\Val$)} \\
  \tilde v
  &\cceq \bot \alt v
  &\text{(partial values, $\tilde \Val$)} \\
  r &\cceq \langle \tilde v \rangle_l &\text{(slot types, $\mathbb S_{\Val}$)}\\
  \\
  S &\in \Loc \mapsto \mathbb S_\Val &\text{(store)} \\
  \\
  \langle \config S e &\Downarrow \config S v\rangle_l &\text{(expressions)} \\
  \langle \config S s &\Downarrow S \ \rangle_l &\text{(statements)} \\
  \langle\config S p &\Downarrow \config S v \rangle_l &\text{(programs)}
\end{align*}

\begin{prooftree}
  \AxiomC{}
  \RightLabel{(loc-var)}
  \UnaryInfC{$x \rightsquigarrow \ell_x$}
\end{prooftree}

\begin{prooftree}
  \AxiomC{$w \rightsquigarrow \ell_x$}
  \AxiomC{$(\ell_x \mapsto \ell_y) \in S$}
  \RightLabel{(loc-drf)}
  \BinaryInfC{$\dref w \rightsquigarrow \ell_y$}
\end{prooftree}

\begin{center}
  \AxiomC{}
  \RightLabel{(unit)}
  \UnaryInfC{$\langle \config S \unitt \evl \config S \unitt \rangle_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$n \in \mathbb Z$}
  \RightLabel{(int)}
  \UnaryInfC{$\langle \config S n \evl \config S n \rangle_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$w \rightsquigarrow \ell_x$}
  \AxiomC{$(\ell_x \mapsto \langle v \rangle_{l_1}) \in S$}
  \RightLabel{(place-copy)}
  \BinaryInfC{$\langle \config S {\copye w} \evl \config S {v} \rangle_{l_2}$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$w \rightsquigarrow \ell_x$}
  \AxiomC{$(\ell_x \mapsto \langle v \rangle_{l_1}) \in S$}
  \RightLabel{(move)}
  \BinaryInfC{$\langle \config S w \evl \config {S[\ell_x \mapsto \langle \bot \rangle_{l_1}]} {v} \rangle_{l_2}$}
  \DisplayProof
\end{center}

\begin{prooftree}
  \AxiomC{$w \rightsquigarrow \ell$}
  \RightLabel{(brw)}
  \UnaryInfC{$\langle \config S {\brw w} \evl \config S {\ell} \rangle_l$}
\end{prooftree}

\begin{prooftree}
  \AxiomC{$w \rightsquigarrow \ell$}
  \RightLabel{(mut-brw)}
  \UnaryInfC{$\langle \config S {\mbrw w} \evl \config S {\ell} \rangle_l$}
\end{prooftree}

\begin{prooftree}
  \AxiomC{$w \rightsquigarrow \ell_x$}
  \AxiomC{$(\ell_x \mapsto \langle \tilde v \rangle_{l_1}) \in S_1$}
  \AxiomC{$\langle \config {S_1} {e} \evl \config {S_2} {v} \rangle_{l_2}$}
  \RightLabel{(assign)}
  \TrinaryInfC{$\langle \config {S_1} {w \eqe e} \evl \config {S_2[\ell_x \mapsto \langle v \rangle_{l_1}]} {\unitt} \rangle_{l_2}$}
\end{prooftree}

\begin{align*}
  \mathsf{drop}(S, l) = S \setminus \{ \ell \mapsto \langle \tilde v \rangle_l : (\ell \mapsto \langle \tilde v \rangle_l) \in S\}
\end{align*}

\begin{prooftree}
  \AxiomC{$\langle \config {S_1} p \evl \config {S_2} v \rangle_{l + 1}$}
  \RightLabel{(block)}
  \UnaryInfC{$\langle \config {S_1} {\code{\{} \ p \ \code{\}}} \evl \config {\mathsf{drop}(S_2, l + 1)} v \rangle_l$}
\end{prooftree}

\begin{center}
  \AxiomC{$\langle \config {S_1} e \evl \config {S_2} v \rangle_l$}
  \RightLabel{(expr-stmt)}
  \UnaryInfC{$\langle \config {S_1} {e} \evl S_2 \ \rangle_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\langle \config {S_1} e \evl \config {S_2} v \rangle_l$}
  \RightLabel{(let)}
  \UnaryInfC{$\langle \config {S_1} {\lett x e} \evl S_2[\ell_x \mapsto \langle v \rangle_l] \ \rangle_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\langle \config {S_1} e \evl \config {S_2} v \rangle_l$}
  \RightLabel{(let-mut)}
  \UnaryInfC{$\langle \config {S_1} {\lete \mute x \eqe e} \evl S_2[\ell_x \mapsto \langle v \rangle_l] \ \rangle_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\langle \config {S_1} e \evl \config {S_2} v \ \rangle_l$}
  \RightLabel{(expr-stmt)}
  \UnaryInfC{$\langle \config {S_1} {e} \evl S_2 \ \rangle_l$}
  \DisplayProof
\end{center}

\begin{center}
  \AxiomC{$\langle \config {S_1} {s} \evl S_2 \ \rangle_l$}
  \AxiomC{$\langle \config {S_2} p \evl \config {S_3} v \rangle_l$}
  \RightLabel{(prog)}
  \BinaryInfC{$\langle \config {S_1} {s \ \code{;} \ p} \evl \config {S_3} v \rangle_l$}
  \DisplayProof
\end{center}
\end{document}
